(function(){function t(e){var t=/(>)(<)(\/*)/g,n=/ *(.*) +\n/g,r=/(<.+>)(.+\n)/g;e=e.replace(t,"$1\n$2$3").replace(n,"$1\n").replace(r,"$1\n$2");var i=0,s="",o=e.split("\n"),u=0,a="other",f={"single->single":0,"single->closing":-1,"single->opening":0,"single->other":0,"closing->single":0,"closing->closing":-1,"closing->opening":0,"closing->other":0,"opening->single":1,"opening->closing":0,"opening->opening":1,"opening->other":1,"other->single":0,"other->closing":-1,"other->opening":0,"other->other":0};for(var l=0;l<o.length;l++){var c=o[l],h=Boolean(c.match(/<.+\/>/)),p=Boolean(c.match(/<\/.+>/)),d=Boolean(c.match(/<[^!].*>/)),v=h?"single":p?"closing":d?"opening":"other",m=a+"->"+v;a=v;var g="";u+=f[m];for(var y=0;y<u;y++)g+="    ";s+=g+c+"\n"}return s}var e=this.sax||require("sax");Ecore.XMI={parse:function(t,n){function o(e){if(!e)return;_.each(e,function(e,t){if(t.indexOf(":")!==-1){var n=t.split(":");n[0]==="xmlns"&&i.push({prefix:n[1],uri:e})}})}function u(e){var t=_.find(i,function(t){return t.prefix===e});return t?t.uri:null}function a(e){if(e.indexOf(":")!==-1){var t=e.split(":"),n=t[0],r=t[1],i=u(n)+"#//"+r;return Ecore.Registry.getEObject(i)}if(f.parent.eObject){var s=f.parent.eObject,o=s.eClass.getEStructuralFeature(e),a=o.get("eType");return a}}function h(){function n(e){return e.substring(0,1)==="/"}function r(t,r,i){var s=i.split(/\s/),o=r.get("upperBound")!==1,u;_.each(s,function(i){n(i)?u=e[i]:u=Ecore.Registry.getEObject(i),u&&(o?t.get(r.get("name")).add(u):t.set(r.get("name"),u))})}var e=t._index();_.each(c,function(e){var t=e.parent,n=e.feature,i=e.value;r(t,n,i)})}var r=e.parser(!0),i=[],s,f,l,c=[];r.onopentag=function(e){o(e.attributes),e.children=[],e.parent=f,e.parent&&e.parent.children.push(e),f=e;var t=a(e.name);if(t){var n=f.eObject=Ecore.create(t);l||(l=n),_.each(e.attributes,function(e,t){if(n.has(t)){var r=n.eClass.getEStructuralFeature(t);r.isTypeOf("EAttribute")?n.set(t,e):c.push({parent:n,feature:r,value:e})}});if(e.parent){var r=e.parent.eObject;if(r.has(e.name)){var i=r.eClass.getEStructuralFeature(e.name);i.get("upperBound")===1?r.set(e.name,n):r.get(e.name).add(n)}}}},r.onclosetag=function(e){if(f&&f.parent){var t=f.parent;delete f.parent,f=t}},r.write(n).close(),t.add(l),h()},toXMI:function(e,n){function u(e){r+="<";var t;e.eContainingFeature?t=e.eContainingFeature.get("name"):t=s+":"+e.eClass.get("name"),r+=t,e.eContainer.isTypeOf("Resource")&&(r+=' xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',r+=" xmlns:"+s+'="'+o+'"');var n=e.eClass.get("eAllStructuralFeatures"),i=_.filter(n,function(t){return t.isTypeOf("EAttribute")&&e.isSet(t.get("name"))}),a=_.filter(n,function(t){return t.isTypeOf("EReference")&&!t.get("containment")&&e.isSet(t.get("name"))});_.each(i,function(t){r+=" "+t.get("name")+'="'+e.get(t.get("name"))+'"'}),_.each(a,function(t){var n=e.get(t.get("name")),i=_.map(n instanceof Ecore.EList?n.array():[n],function(e){return e.fragment()});r+=" "+t.get("name")+'="'+i.join(" ")+'"'});if(e.eContents().length===0)r+="/>";else{r+=">";var f=_.filter(n,function(t){return t.isTypeOf("EReference")&&t.get("containment")&&e.isSet(t.get("name"))});_.each(f,function(t){var n=e.get(t.get("name"));t.get("upperBound")!==1?n.each(function(e){u(e)}):u(n)}),r+="</"+t+">"}return r}var r="",i=e.get("contents").first(),s=i.eClass.eContainer.get("nsPrefix"),o=i.eClass.eContainer.get("nsURI");return u(i),r=n?t(r):r,r='<?xml version="1.0" encoding="UTF-8"?>\n'+r,r}}})();