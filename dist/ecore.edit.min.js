(function(){function t(e){var t=$('div [class*="window-header"]',$(e));t.mousedown(function(t){function n(t){var n=e.style.position;e.style.position="absolute",e.style.left=t.clientX+window.pageXOffset-e.innerX+"px",e.style.top=t.clientY+window.pageYOffset-e.innerY+"px",e.style.position=n}e.innerX=t.clientX+window.pageXOffset-e.offsetLeft,e.innerY=t.clientY+window.pageYOffset-e.offsetTop,window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",n,!1)},!0)})}function n(e,t){var n=$('div[class*="window-resize"]',$(t));n.mousedown(function(e){function n(e){t.ow=t.offsetWidth,t.oh=t.offsetHeight;var n=e.clientX-t.startX,r=e.clientY-t.startY;t.startX+=n,t.startY+=r;var i=t.style.position;t.style.position="absolute";var s=t.ow;t.style.width=t.ow+n*.9+"px",t.style.position=i}t.startX=e.clientX,t.startY=e.clientY,window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",n,!1)},!0)})}function m(e){return _.find(Ecore.Editor._views,function(t){return t.cid===e})}Ecore.Editor={};var e=function(){var e=this.has("name")?this.get("name"):this.get("uri");return this.eClass.get("name")+e?" "+e:""};Ecore.EObject.get("eOperations").add(Ecore.EOperation.create({name:"label",eType:Ecore.EString,upperBound:1,lowerBound:0,_:e})),_.each(Ecore.Registry.models(),function(t){t.label=e,t.get("contents").each(function(t){t.label=e,t.get("eClassifiers").each(function(t){t.label=e,t.has("eStructuralFeatures")&&(t.get("eStructuralFeatures").each(function(e){e.label=function(){return this.get("name")+" : "+this.get("eType").get("name")}}),t.get("eOperations").each(function(e){e.label=function(){return this.get("name")+"()"+(this.isSet("eType")?" : "+this.get("eType").get("name"):"")}}))})})}),Ecore.Editor.Window=Backbone.View.extend({_template:_.template('<div class="row-fluid"><div class="window-header"><span class="window-title"><%= title %></span><span class="window-actions"></span></div><div class="window-content"></div><div class="window-footer"></div></div>'),_resizeHandleTemplate:_.template('<div class="window-resize" style="z-index: 1000;"></div>'),_closeActionTemplate:_.template('<a href="#" class="window-action"><i class="icon-remove action-close"></i></a>'),_minimizeActionTemplate:_.template('<a href="#" class="window-action"><i class="icon-minus action-min"></i></a>'),_maximizeActionTemplate:_.template('<a href="#" class="window-action"><i class="icon-plus action-max"></i></a>'),events:{'click i[class*="action-close"]':"close",'click i[class*="action-min"]':"minimize",'click i[class*="action-max"]':"maximize"},initialize:function(e){_.bindAll(this,"render","remove","close","minimize","maximize"),this.parts=e.parts,this.title=e.title||"Window",this.height=e.height,this.draggable=e.draggable},render:function(){this.remove();if(this.$header)return;var e=this._template({title:this.title});return this.$el.addClass("window"),this.$el.append(e),this.$header=$('div > div[class*="window-header"]',this.$el),$('span[class*="window-actions"]',this.$el).append(this._minimizeActionTemplate()).append(this._maximizeActionTemplate()).append(this._closeActionTemplate()),$('div[class*="window-footer"]',this.$el).append(this._resizeHandleTemplate()),this.$content=$('div > div[class*="window-content"]',this.$el),this.height&&this.$content.css("height",this.height),this.content&&(this.content.render(),this.$content.append(this.content.$el)),this.draggable&&t(this.$el.get()[0]),n(this,this.$el.get()[0]),this},remove:function(){},close:function(){console.log("closing")},maximize:function(){this.$el.css("left","0"),this.$el.css("right","0")},minimize:function(){}}),Ecore.Editor.SimpleWindow=Ecore.Editor.Window.extend({header:_.template("<div></div>"),initialize:function(e){this.title=e.title||"Window",this.height=e.height,this.draggable=e.draggable,this.content=e.content}});var r=Ecore.Editor.MenuBar=Backbone.View.extend({template:_.template('<div class="span12 action-bar btn-group"></div>'),initialize:function(e){this.buttons=e.buttons},render:function(){var e=this.template();return this.$el.append(e),_.each(this.buttons,this.renderButton,this),this},renderButton:function(e){return e.render(),$('div[class*="action-bar"]',this.$el).append(e.$el),this}}),i=Ecore.Editor.MenuBarButton=Backbone.View.extend({template:_.template('<a class="btn btn-mini"> <%= label %> </a>'),events:{click:"click"},initialize:function(e){_.bindAll(this,"render","click"),this.label=e.label,this.clickHandle=e.click},render:function(){var e=this.template({label:this.label});return this.setElement(e),this},click:function(){return this.clickHandle()}}),s=Ecore.Editor.MenuBarDropDownButton=i.extend({template:_.template('<a class="btn btn-mini" data-toggle="dropdown"> <%= label %> <span class="caret"> </span></a><ul class="dropdown-menu"></ul>'),initialize:function(e){_.bindAll(this,"render","click"),this.label=e.label,this.items=e.items||[],this.clickHandle=e.click},render:function(){var e=this.template({label:this.label});return this.setElement(e),this.removeItem(),_.each(this.items,this.renderItem,this),this},renderItem:function(e){return e.render(),$(this.$el[1]).append(e.$el),this},removeItem:function(e){return this.items.length=0,$(this.$el[1]).children().remove(),this},addItem:function(e){return this.items.push(e),this}}),o=Ecore.Editor.Separator=Backbone.View.extend({template:_.template('<li class="divider"></li>'),render:function(){var e=this.template();return this.setElement(e),this}}),u=Ecore.Editor.DropDownItem=Backbone.View.extend({template:_.template('<li><a tabindex="-1" href="#"><%= label %></a></li>'),events:{"click a":"click"},initialize:function(e){_.bindAll(this,"render","click"),this.label=e.label,this.handleClick=e.click},render:function(){var e=this.template({label:this.label});return this.setElement(e),this},click:function(){return this.handleClick()},remove:function(){}}),a=Ecore.Editor.MenuBarButton,f=Ecore.Editor.ExplorerWindow=Ecore.Editor.Window.extend({menuBarTemplate:_.template('<div class="row-fluid"></div>'),explorerTemplate:_.template('<div class="row-fluid"></div>'),selectRootTemplate:_.template('<% _.each(classes, function(c) { %> <option> <%= c.get("name") %> </option> <% }); %>'),initialize:function(e){Ecore.Editor.Window.prototype.initialize.apply(this,[e])},renderMenuBar:function(){var e=this.menuBarTemplate();this.menu=new Ecore.Editor.MenuBar({el:e,buttons:[new a({label:"add"}),new a({label:"remove"}),new a({label:"edit"}),new a({label:"diagram"})]}),this.menu.render(),this.$content.append(this.menu.$el)},renderTree:function(){var e=this.explorerTemplate();this.tree=new Ecore.Editor.TreeView({el:e,model:this.model}),this.tree.render(),this.$content.append(this.tree.$el),this.tree.show()},render:function(){return Ecore.Editor.Window.prototype.render.apply(this),this.remove(),this.renderMenuBar(),this.renderTree(),this},remove:function(){return Ecore.Editor.Window.prototype.remove.call(this),this.$content&&this.$content.children().remove(),this}}),l=Ecore.Editor.PropertyWindow=Ecore.Editor.Window.extend({contentTemplate:_.template('<table class="table table-striped"><thead><tr><th style="width: 30%"></th><th style="width: 70%"></th></tr></thead><tbody></tbody></table>'),initialize:function(e){Ecore.Editor.Window.prototype.initialize.apply(this,[e]),this.views=[]},renderTable:function(){if(!this.model||!this.model.eClass)return;var e=this.contentTemplate(),t=_.filter(this.model.eClass.get("eAllAttributes"),function(e){return!e.get("derived")}),n=_.filter(this.model.eClass.get("eAllReferences"),function(e){return!e.get("derived")});this.$content.append(e),this.views.push(new d({model:{eFeatureName:"eClass",eObject:this.model,value:this.model.eClass}})),_.each(t,function(e){this.views.push(new d({model:{eFeature:e,eObject:this.model}}))},this),_.each(n,function(e){this.views.push(new d({model:{eFeature:e,eObject:this.model}}))},this),_.each(this.views,function(e){e.render(),$("table > tbody",this.$el).append(e.$el)})},render:function(){return Ecore.Editor.Window.prototype.render.apply(this),this.remove(),this.renderTable(),this},remove:function(){return _.each(this.views,function(e){e.remove()}),this.views.length=0,this.$content&&this.$content.children().remove(),this}});$("[contenteditable]").live("focus",function(){var e=$(this);return e.data("before",e.html()),e}).live("blur keyup paste",function(){var e=$(this);return e.data("before")!==e.html()&&(e.data("before",e.html()),e.trigger("change")),e});var c=Backbone.View.extend({template:_.template("<div contenteditable><%= value %></div>"),render:function(){var e=this.template({value:this.model});this.setElement(e);var t=this;return this.$el.on("change",function(){t.trigger("change",t.$el.text())}),this}}),h=Backbone.View.extend({}),p=Backbone.View.extend({template:_.template('<% if (many) { %> <div class=""> <% } %> <select <% if (many) { %> multiple="multiple" <% } %> > <% _.each(options, function(opt) { %><option><%= opt.eClass ? opt.label() : opt %></option><% }); %></select> <% if (many) { %> </div><div class="btn-group"><a class="btn-mini"><i class="icon-plus"></i></a><a class="btn-mini"><i class="icon-remove"></i></a></div> <% } %>'),initialize:function(e){this.value=e.value,this.many=e.many||!1},render:function(){var e=this.template({options:this.model,value:this.value,many:this.many});this.setElement(e),this.$el.val(this.value?this.value.eClass?this.value.label():this.value:null);var t=this;return this.$el.change(function(){var e=$("option:selected",t.$el).val();t.trigger("change",e)}),this}}),d=Ecore.Editor.PropertyRowView=Backbone.View.extend({propertyTemplate:_.template("<tr><td><%= name %></td></tr>"),valueTemplate:_.template("<td></td>"),initialize:function(){this.eFeature=this.model.eFeature,this.eFeatureName=this.model.eFeatureName||this.eFeature.get("name"),this.value=this.model.value,this.eType=this.eFeature?this.eFeature.get("eType"):null},render:function(){var e=this.eFeature,t=this.eFeatureName,n=this.eType,r=this.model.eObject,i=this.value||r.get(t),s=this.propertyTemplate({name:t}),o;this.setElement(s),e?e.get("upperBound")!==1?o=new p({model:e.get("derived")?i:i.array(),value:i,many:!0}):e.isTypeOf("EAttribute")?n===Ecore.EBoolean?(o=new p({model:["true","false"],value:i}),o.on("change",function(e){r.set(t,e),r.trigger("change"),r.eResource().trigger("change",r)})):(o=new c({model:i}),o.on("change",function(e){r.set(t,e),r.trigger("change"),r.eResource().trigger("change",r)})):o=new p({model:i?[i]:[],value:i}):(o=new p({model:[i],value:i,many:!1}),o.on("change",function(e){console.log(e)}));if(o){o.render();var u=$(document.createElement("td"));u.append(o.$el),this.$el.append(u)}return this},remove:function(){return this.$el.remove(),this}});Ecore.Editor.Tabbable=Backbone.View.extend({el:"#edit-tabs",template:_.template('<div class="tabbable"><ul class="nav nav-tabs"></ul><div class="tab-content"></div></div>'),initialize:function(){this.tabs=[]},render:function(){this.remove();var e=this.template();return this.$el.append(e),this.$tabs=$("ul",this.$el),this.$content=$('div[class*="tab-content"]',this.$el),_.each(this.tabs,function(e){e.render()},this),this},addTab:function(e){return e.parent=this,e.on("close",this.close),this.tabs.push(e),this},close:function(e){return e.remove(),this.tabs=_.without(this.tabs,e),this},remove:function(){return this.$el.children().remove(),this}}),Ecore.Editor.Tab=Backbone.View.extend({templateContent:_.template('<div class="tab-pane" id="tab-<%= id %>"></div>'),events:{},intialize:function(e){_.bindAll(this)},render:function(){var e=this.templateContent({id:this.cid});this.setElement(e),this.parent.$content.append(this.$el),this.tab=new v({id:this.cid,label:this.model.label()}),this.tab.on("close",function(){this.trigger("close",this)},this),this.tab.render(),this.$tab=this.tab.$el,this.parent.$tabs.append(this.$tab);var t=this;return this.$tab.on("shown",function(){t.renderContent()}),this},renderContent:function(){},show:function(){this.$tab.show()},remove:function(){this.$tab.remove(),this.tab.off(),delete this.tab,this.$el.remove()}});var v=Backbone.View.extend({template:_.template('<li><a href="#tab-<%= id %>" data-toggle="tab"> <%= label %> <i class="icon-remove-circle"></i> </a></li>'),events:{click:"show",'click i[class*="icon-remove"]':"close"},initialize:function(e){this._id=e.id,this.label=e.label},render:function(){this.remove();var e=this.template({id:this._id,label:this.label});return this.setElement(e),this},close:function(){this.trigger("close",this)},show:function(){this.$el.tab("show")},remove:function(){}});Ecore.Editor._views=[],Ecore.Editor.Workbench={windows:[],add:function(e){this.windows.push(e)}},Ecore.Editor.EditorWindow=Ecore.Editor.Window.extend({intialize:function(e){Ecore.Editor.Window.prototype.initialize.call(this,e)},renderEditor:function(){return this.editor=new Ecore.Editor.TreeTabEditor({model:this.model}),this.editor.render(),this.$content.append(this.editor.$el),this},render:function(){return Ecore.Editor.Window.prototype.render.call(this),this.renderEditor(),this}}),Ecore.Editor.TabEditor=Backbone.View.extend({elementTemplate:_.template('<div><div class="tabbable"><ul class="nav nav-tabs"></ul><div class="tab-content"></div></div></div>'),template:_.template('<li><a href="#tab-<%= id %>" data-toggle="tab"> <%= uri %> <i class="icon-remove-circle"></i> </a></li>'),templateTab:_.template('<div class="tab-pane" id="tab-<%= id %>"></div>'),initialize:function(e){_.bindAll(this,"render","active","remove"),Ecore.Editor._views.push(this)},render:function(){var e=this.model.uri,t=this.elementTemplate(),n=this.template({id:this.cid,uri:e}),r=this.templateTab({id:this.cid,uri:e});this.setElement(t),$(".tabbable > .nav-tabs",this.$el).append(n),$(".tab-content",this.$el).append(r),this.$content=$(".tab-content > #tab-"+this.cid,this.$el),this.renderContent(this.cid),this.$a=$('li > a[href="#tab-'+this.cid+'"]',this.$el),this.$tab=$("#tab-"+this.cid,this.$el),this.$a.click(this.active),this.$a.on("shown",function(e){var t=m(e.target.href.split("-")[1]);t&&(t.selected=!0);if(e.relatedTarget){var n=m(e.relatedTarget.href.split("-")[1]);n&&(n.selected=!1)}});var i=this;return $("i",this.$a).click(function(){i.remove(),$("#editor a:first").tab("show")}),this.$el.tab("show"),this},active:function(){this.$el.tab("show")},remove:function(){this.$a.remove(),this.$tab.remove()}}),Ecore.Editor.TreeTabEditor=Ecore.Editor.TabEditor.extend({menuBarTemplate:_.template('<div class="row-fluid"></div>'),contentTemplate:_.template('<div class="row-fluid"><div class="pointer tree-node" id="tree-<%= id %>"></div></div>'),initialize:function(e){_.bindAll(this,"render","active"),Ecore.Editor._views.push(this),this._window=e._window},renderMenuBar:function(){var e=this.menuBarTemplate(),t=this;this.menuBar=new Ecore.Editor.MenuBar({el:e,buttons:[new Ecore.Editor.MenuBarDropDownButton({label:"add",click:function(){var e=t.tree.currentSelection;if(!e)return;var n=e.model,r=n.eClass.eAllContainments(),i=n.eContainingFeature;this.removeItem(),_.each(r,function(e){var t=e.get("eType"),n=t.get("abstract")?t.eAllSubTypes():[t];_.each(n,function(e){this.addItem(new Ecore.Editor.DropDownItem({label:"Child "+e.get("name")}))},this)},this);var s;if(i){var o=i.get("eType");s=o.get("abstract")?o.eAllSubTypes():[o],r.length>0&&this.addItem(new Ecore.Editor.Separator),_.each(s,function(e){this.addItem(new Ecore.Editor.DropDownItem({label:"Sibling "+e.get("name")}))},this)}_.each(this.items,this.renderItem,this)}}),new Ecore.Editor.MenuBarButton({label:"remove",click:function(){}})]}),this.menuBar.render(),this.$content.append(this.menuBar.$el)},renderContent:function(e){this.renderMenuBar(),html=this.contentTemplate({id:e}),this.tree=new Ecore.Editor.TreeView({el:$("#tree-"+e,$(html)),model:this.model}),this.tree.render(),this.tree.show(),this.$content.append(this.tree.$el);var t=this,n=$('div > div > a[class*="add"]',this.$content);return n.click(function(){t.showAddMenu(t.tree.currentSelection)}),this},createSibling:function(e){var t=Ecore.create(e);return this.tree.currentSelection.eContainer.get(this.tree.currentSelection.eContainingFeature.get("name")).add(t),t},createChild:function(e,t){var n=Ecore.create(e);return this.tree.currentSelection.get(t.get("name")).add(n),n}});var g=Ecore.Editor.TreeView=Backbone.View.extend({template:_.template('<div class="tree"></div>'),initialize:function(e){_.bindAll(this,"render","remove"),this.properties=e.properties,this.el=e.el,this.on("select",function(e){this.currentSelection&&this.currentSelection!==e&&this.currentSelection.deselect(),this.currentSelection=e},this)},render:function(){this.remove(),this.views=[];var e=this.template();return _.each(_.isArray(this.model)?this.model:[this.model],function(e){var t=new y({model:e,tree:this});this.views.push(t)},this),this.setElement(e),this},show:function(){return _.each(this.views,function(e){e.render(),this.$el.append(e.$el)},this),this},remove:function(){return this.$el.children().remove(),this}}),y=Ecore.Editor.TreeNodeView=Backbone.View.extend({template:_.template('<ul class="tree-node <% if ( root ) { %> tree-root <% } %>"></ul>'),innerTemplate:_.template('<li><div><span class="icon-chevron-right"></span><span class="state"><span class="icon-tree-<%= eClass %> folder"></span><%= name %></span></div></li>'),initialize:function(e){_.bindAll(this,"render","expand","select","innerRender"),this.expanded=!1,this.tree=e.tree},expand:function(){var e=this.model.eContents();return _.isEmpty(e)?this:(this.expanded?(this.$el.children().remove(),this.innerRender(),this.expanded=!1):(_.each(e,function(e){var t=new y({model:e,tree:this.tree});t.render(),this.$el.append(t.$el)},this),this.expanded=!0),this)},render:function(){var e=this.model.eContainer,t=this.template({root:e?e.isTypeOf("Resource"):!0});return this.setElement(t),this.innerRender()},innerRender:function(){var e=this.innerTemplate({eClass:this.model.eClass.get("name"),name:this.model.label(),icon:this.model.eContents().length===0?"-":"+"});this.$el.append(e);var t=this;return $('div > span[class*="icon-chevron-right"]',this.$el).click(function(){t.expand()}),!this.properties&&Ecore.Editor.PropertyView&&(this.properties=new Ecore.Editor.PropertyView({model:this.model})),$("div",this.$el).mouseover(function(){t.tree.currentSelection!==t&&$('div > span[class*="state"]:first',t.$el).addClass("tree-over")}),$("div",this.$el).mouseout(function(){$('div > span[class*="state"]:first',t.$el).removeClass("tree-over")}),$("div",this.$el).click(function(){t.select(),t.properties&&(t.properties.remove(),t.properties.render())}),this},deselect:function(){return $('div > span[class*="state"]:first',this.$el).removeClass("tree-selected"),this.tree.trigger("deselect",this),this},select:function(){return $('div > span[class*="state"]:first',this.$el).addClass("tree-selected"),this.tree.trigger("select",this),this}})})();